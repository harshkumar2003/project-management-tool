<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Management tools</title>
    <link rel="stylesheet" href="home.css">
</head>

<body>
    <div class="nav-main">
        <div class="navbar">
            <ul>
                <li><a href="http://127.0.0.1:5500/index.html">Home</a></li>
                <li class="dropdown">
                    <button onclick="myFunction()" class="dropbtn">Manage
                        <i class="fa-solid fa-circle-chevron-down"></i>
                    </button>
                    <div id="myDropdown" class="dropdown-content">
                        <a href="http://127.0.0.1:5500/Assigned task.html">Assigned Task</a>
                    </div>
                </li>
                <li><a href="#">About-us</a></li>
            </ul>
        </div>
        <div class="centre">
            <img src="logo.png" alt="logo">
        </div>
        <div class="user">
            <button onclick="document.getElementById('id03').style display='block'" class="btn1" id="info" name="info">
                <span class="material-symbols-outlined">account_circle</span>
            </button>
            <div id="user-email"></div> <!-- This is where the user's email will be displayed -->
            <button onclick="logout()" class="btn1" id="logout" name="logout">Logout</button>
        </div>
    </div>
    <div class="main-content">
        <form id="project-form">
            <div class="box">
                <h5>Assign Work</h5>
                <label for="project"><b>Project Name</b></label>
                <input type="text" placeholder="Type Project" id="project" name="project" required><br>
                <label for="assign"><b>Assign User</b></label>
                <input type="email" placeholder="Assign" id="assign" name="assign" required><br>
                <label for="assigntask"><b>Assign Task</b></label>
                <input type="text" placeholder="Task" id="assigntask" name="assigntask" required><br>
            </div>
            <div class="radio">
                <label for="priority">Priority:</label>
                <input type="radio" id="urgent" name="priority" value="urgent">
                <label for="urgent">urgent</label>
                <input type="radio" id="medium" name="priority" value="medium">
                <label for="medium">medium</label>
                <input type="radio" id="normal" name="priority" value="normal">
                <label for="normal">normal</label><br>
                <div class="btn22">
                    <button type="submit" id="submit" name="submit" class="done">Submit</button>
                </div>
            </div>
        </form>
    </div>
    <script src="script1.js"></script>
    <script src="https://kit.fontawesome.com/fd42e4e9fb.js" crossorigin="anonymous"></script>

    <script type="module">
        // Import Firebase SDK modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
        import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBqyYXndru5uVI60tp6eu3A1A7Jho-1Fys",
            authDomain: "login-auth-7a8b9.firebaseapp.com",
            databaseURL: "https://login-auth-7a8b9-default-rtdb.firebaseio.com",
            projectId: "login-auth-7a8b9",
            storageBucket: "login-auth-7a8b9.appspot.com",
            messagingSenderId: "786370328154",
            appId: "1:786370328154:web:75193de1d672e27e700a63"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        document.addEventListener("DOMContentLoaded", function () {
            auth.onAuthStateChanged(function (user) {
                if (user) {
                    const email = user.email;
                    document.getElementById("user-email").textContent = "User Email: " + email;
                    setupProjectForm(user);
                } else {
                    // Redirect to the login page if the user is not authenticated.
                    window.location.href = 'http://127.0.0.1:5500/index.html';
                }
            });

            document.getElementById('logout').addEventListener("click", function () {
                logout();
            });
        });

        function setupProjectForm(user) {
            const projectForm = document.getElementById("project-form");
            projectForm.addEventListener("submit", function (e) {
                e.preventDefault();
                const assignedUserEmail = projectForm.elements.assign.value.trim();
                verifyAssignedUser(assignedUserEmail, user, projectForm);
            });
        }

        // Function to verify the assigned user and submit the project
        function verifyAssignedUser(email, user, projectForm) {
            if (!user) {
                console.error("User is not authenticated.");
                return;
            }

            const usersRef = ref(database, 'users');

            get(usersRef)
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        if (userData) {
                            let userExists = false;
                            // Check if the email exists in the userData
                            for (const uid in userData) {
                                if (userData[uid].email === email) {
                                    userExists = true;
                                    break;
                                }
                            }
                            if (userExists) {
                                // The user exists, proceed with submitting the project.
                                const projectName = projectForm.elements.project.value;
                                const assignTask = projectForm.elements.assigntask.value;
                                const priority = projectForm.querySelector('input[name="priority"]:checked').value;

                                const projectsRef = ref(database, 'projects');
                                const newProjectRef = push(projectsRef);
                                set(newProjectRef, {
                                    projectName: projectName,
                                    assignUser: email,
                                    assignTask: assignTask,
                                    priority: priority
                                })
                                    .then(() => {
                                        alert("Project data added to the database!");
                                        projectForm.reset();
                                    })
                                    .catch((error) => {
                                        console.error("Error storing data: " + error.message);
                                    });
                            } else {
                                alert("Invalid assigned user. Please enter a valid user.");
                            }
                        } else {
                            console.error("User data does not exist.");
                        }
                    } else {
                        console.error("Snapshot does not exist.");
                    }
                })
                .catch((error) => {
                    console.error("Error fetching user data: " + error.message);
                });
        }

        // Function to log out
        function logout() {
            auth.signOut().then(function () {
                document.getElementById("user-email").textContent = "User Email: Loading...";
                window.location.href = 'http://127.0.0.1:5500/index.html';
            }).catch(function (error) {
                console.error("Error logging out: " + error.message);
            });
        }
    </script>
</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assigned task</title>
    <link rel="stylesheet" href="home.css">
</head>

<body>
    <div class="nav-main">

        <div class="navbar">
            <ul>
                <li><a href="http://127.0.0.1:5500/index.html">Home</a></li>

                <li class="dropdown">
                    <button onclick="myFunction()" class="dropbtn">Manage
                        <i class="fa-solid fa-circle-chevron-down"></i>
                    </button>
                    <div id="myDropdown" class="dropdown-content">
                        <a href="#">Assigned Task</a>
                    </div>
                </li>
                <li><a href="#">About-us</a></li>
            </ul>
        </div>
        <div class="centre">
            <img src="logo.png" alt="logo">
        </div>
        <div class="user">
            <button onclick="document.getElementById('id03').style.display='block'" class="btn1" id="info" name="info">
                <span class="material-symbols-outlined">account_circle</span>
            </button>
            <div id="user-email"></div> <!-- This is where the user's email will be displayed -->
            <button onclick="logout()" class="btn1" id="logout" name="logout">Logout</button>
        </div>
    </div>
    <div class="main">
        <h4>Yor Assigned Work</h4>
        <ul id="task-list">
            <!-- Task items will be dynamically added here using JavaScript -->
        </ul>


    </div>

</body>
<script src="script1.js"></script>
<script src="https://kit.fontawesome.com/fd42e4e9fb.js" crossorigin="anonymous"></script>
<!-- <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js"></script>
<script src="assigned-task.js"></script> -->

<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-analytics.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
    import { getDatabase, ref, set, get, push } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
    //import { getAuth } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";

    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyBqyYXndru5uVI60tp6eu3A1A7Jho-1Fys",
        authDomain: "login-auth-7a8b9.firebaseapp.com",
        databaseURL: "https://login-auth-7a8b9-default-rtdb.firebaseio.com",
        projectId: "login-auth-7a8b9",
        storageBucket: "login-auth-7a8b9.appspot.com",
        messagingSenderId: "786370328154",
        appId: "1:786370328154:web:75193de1d672e27e700a63"
    };
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics();
    const auth = getAuth(app);
    const database = getDatabase(app);
    const user = auth.currentUser;
    console.log(app);
    console.log(database);
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById('info').addEventListener("click", function () {
            const user = auth.currentUser;
            if (user !== null) {
                const email = user.email;
                const uid = user.uid;
                document.getElementById("user-email").textContent = "User Email: " + email;
            }
        });

        document.getElementById('logout').addEventListener("click", function () {
            logout();
        });

        function logout() {
            signOut(auth).then(function () {
                document.getElementById("user-email").textContent = "";
                window.location.href = 'http://127.0.0.1:5500/index.html';
            }).catch(function (error) {
                console.error("Error logging out: " + error.message);
            });
        }


        const user = auth.currentUser;
        if (user !== null) {
            const userEmail = user.email;
            document.getElementById("user-email").textContent = "User Email: " + userEmail;
            displayAssignedTasksForUser(userEmail);
        }
    });
    // Initialize Firebase (Use the same Firebase configuration as in your original HTML file)

// Function to fetch and display assigned tasks
function fetchAssignedTasks() {
    const user = auth.currentUser;

    if (user !== null) {
        const uid = user.uid;
        const assignedTasksRef = ref(database, `assignedTasks/${uid}`);

        get(assignedTasksRef).then((snapshot) => {
            const taskList = document.getElementById("task-list");
            taskList.innerHTML = ''; // Clear the task list

            if (snapshot.exists()) {
                const data = snapshot.val();

                for (const taskId in data) {
                    const task = data[taskId];
                    const listItem = document.createElement("li");
                    listItem.textContent = `Task: ${task.taskName}, Priority: ${task.priority}`;
                    taskList.appendChild(listItem);
                }
            } else {
                const message = document.createElement("p");
                message.textContent = "No assigned tasks found.";
                taskList.appendChild(message);
            }
        }).catch((error) => {
            console.error("Error fetching assigned tasks: " + error.message);
        });
    }
}

// Call the function to fetch and display assigned tasks when the page loads
window.addEventListener("load", fetchAssignedTasks);

</script>

</html>