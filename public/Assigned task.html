<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Projects</title>
    <link rel="stylesheet" href="home.css">
</head>

<body>
    <div class="nav-main">
        <div class="navbar">
            <ul>
                <li><a href="http://127.0.0.1:5500/index.html">Home</a></li>
                <li class="dropdown">
                    <button onclick="myFunction()" class="dropbtn">Manage
                        <i class="fa-solid fa-circle-chevron-down"></i>
                    </button>
                    <div id="myDropdown" class="dropdown-content">
                        <a href="http://127.0.0.1:5500/home.html">Assign Work</a>
                    </div>
                </li>
                <li><a href="#">About-us</a></li>
            </ul>
        </div>
        <div class="centre">
            <img src="logo.png" alt="logo">
        </div>
        <div class="user">
            <button onclick="document.getElementById('id03').style.display='block'" class="btn1" id="info" name="info">
                <span class="material-symbols-outlined">account_circle</span>
            </button>
            <div id="user-email"></div> <!-- This is where the user's email will be displayed -->
            <button onclick="logout()" class="btn1" id="logout" name="logout">Logout</button>
        </div>
    </div>
    <div class="details">
        <h5>Your Assigned Task</h5>

        <div class="project-details">

            <!-- Project details will be displayed here -->
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
        import { getDatabase, ref, get, set, remove } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBqyYXndru5uVI60tp6eu3A1A7Jho-1Fys",
            authDomain: "login-auth-7a8b9.firebaseapp.com",
            databaseURL: "https://login-auth-7a8b9-default-rtdb.firebaseio.com",
            projectId: "login-auth-7a8b9",
            storageBucket: "login-auth-7a8b9.appspot.com",
            messagingSenderId: "786370328154",
            appId: "1:786370328154:web:75193de1d672e27e700a63"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        document.addEventListener("DOMContentLoaded", function () {
            auth.onAuthStateChanged(function (user) {
                if (user) {
                    const email = user.email;
                    document.getElementById("user-email").textContent = "User Email: " + email;
                    displayUserProjects(email);
                } else {
                    // Redirect to the login page if the user is not authenticated.
                    window.location.href = 'http://127.0.0.1:5500/index.html';
                }
            });
        });

        function displayUserProjects(userEmail) {
            const projectsRef = ref(database, 'projects');

            // Debugging: Log before fetching data
            console.log("Fetching project data...");

            get(projectsRef)
                .then((snapshot) => {
                    // Debugging: Log the snapshot
                    console.log("Snapshot:", snapshot);

                    if (snapshot.exists()) {
                        const projectData = snapshot.val();

                        if (projectData) {
                            let projectsHTML = "";

                            for (const projectId in projectData) {
                                const project = projectData[projectId];
                                if (project.assignUser === userEmail) {
                                    projectsHTML += `
                                <p>Project Name: ${project.projectName}</p>
                                <p>Task: ${project.assignTask}</p>
                                <p>Priority: ${project.priority}</p>
                                <button type="button" id="complete" name="complete" data-project-id="${projectId}">Complete</button>
                                <hr>
                            `;
                                }
                            }

                            if (projectsHTML !== "") {
                                document.querySelector(".project-details").innerHTML = projectsHTML;
                            } else {
                                document.querySelector(".project-details").innerHTML = "No projects found for this user.";
                            }
                        } else {
                            document.querySelector(".project-details").innerHTML = "No projects found for this user.";
                        }
                    } else {
                        console.log("Snapshot does not exist."); // Debugging output
                        document.querySelector(".project-details").innerHTML = "No projects found for this user.";
                    }
                })
                .catch((error) => {
                    console.error("Error fetching project data: " + error.message);
                });
        }

        document.addEventListener("click", function (e) {
            if (e.target && e.target.id === "complete") {
                // Complete button clicked
                const projectId = e.target.getAttribute("data-project-id");
                if (projectId) {
                    // Handle marking the project as complete
                    markProjectComplete(projectId);
                }
            }
        });

        // ...

function markProjectComplete(projectId) {
    console.log("Marking project as complete:", projectId);

    const projectRef = ref(database, 'projects/' + projectId);

    get(projectRef)
        .then((snapshot) => {
            if (snapshot.exists()) {
                const projectData = snapshot.val();
                console.log("Project Data:", projectData);

                const completedProjectsRef = ref(database, 'completed_work');

                set(ref(completedProjectsRef, projectId), projectData)
                    .then(() => {
                        remove(projectRef)
                            .then(() => {
                                alert("Project marked as complete and moved to 'completed_work'.");
                                displayUserProjects(userEmail); // Refresh the project list
                            })
                            .catch((error) => {
                                console.error("Error removing project: " + error.message);
                            });
                    })
                    .catch((error) => {
                        console.error("Error marking project as complete: " + error.message);
                    });
            } else {
                console.error("Project not found.");
            }
        })
        .catch((error) => {
            console.error("Error fetching project data: " + error.message);
        });
}


        function logout() {
            auth.signOut().then(function () {
                document.getElementById("user-email").textContent = "User Email: Loading...";
                window.location.href = 'http://127.0.0.1:5500/index.html';
            }).catch(function (error) {
                console.error("Error logging out: " + error.message);
            });
        }
    </script>
    <script src="script1.js"></script>
    <script src="https://kit.fontawesome.com/fd42e4e9fb.js" crossorigin
